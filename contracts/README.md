### Содержание
- [Что такое смарт-контракты](#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-%D1%81%D0%BC%D0%B0%D1%80%D1%82-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%B0%D0%BA%D1%82%D1%8B)
- [Пример смарт-контракта](#%D0%BF%D1%80%D0%B8%D0%BC%D0%B5%D1%80-%D1%81%D0%BC%D0%B0%D1%80%D1%82-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%B0%D0%BA%D1%82%D0%B0)
- [Как смарт-контракт попадает в сеть?](#%D0%BA%D0%B0%D0%BA-%D1%81%D0%BC%D0%B0%D1%80%D1%82-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%B0%D0%BA%D1%82-%D0%BF%D0%BE%D0%BF%D0%B0%D0%B4%D0%B0%D0%B5%D1%82-%D0%B2-%D1%81%D0%B5%D1%82%D1%8C)
- [Что такое ABI контракта?](#%D1%87%D1%82%D0%BE-%D1%82%D0%B0%D0%BA%D0%BE%D0%B5-abi-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%B0%D0%BA%D1%82%D0%B0)
- [События контракта](#%D1%81%D0%BE%D0%B1%D1%8B%D1%82%D0%B8%D1%8F-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%B0%D0%BA%D1%82%D0%B0)
- [Как обратиться к контракту с помощью web3?](#%D0%BA%D0%B0%D0%BA-%D0%BE%D0%B1%D1%80%D0%B0%D1%82%D0%B8%D1%82%D1%8C%D1%81%D1%8F-%D0%BA-%D0%BA%D0%BE%D0%BD%D1%82%D1%80%D0%B0%D0%BA%D1%82%D1%83-%D1%81-%D0%BF%D0%BE%D0%BC%D0%BE%D1%89%D1%8C%D1%8E-web3)

#### Что такое смарт-контракты

Смарт-контракты - это децентрализованное программное обеспечение, ориентированное на взаимодействие с блокчейном. Это компьютерный код, работающий в блокчейне, содержащий в себе набор правил, в соответствии с которыми, стороны этого смарт-контракта приходят к соглашению. Когда правила соглашения соблюдены, соглашение **автоматически** применяется. Код смарт-контракта проверяет и облегчает выполнение обязательств. Основной инструмент для реализации смарт-контрактов - это язык программирования `Solidity`.

Каждый смарт-контракт обладает уникальным адресом в сети. У смарт-контракта есть методы для чтения (read-методы) и методы для вызова (write-методы). Наличие методов (функций) говорит о том, что со смарт-контрактами можно взаимодействовать в различных приложениях (mobile, desktop, web), т.е. "вести общение с блокчейном".

Для того, чтобы можно было пользоваться смарт-контрактом необходимо знать его адрес.

#### Пример смарт-контракта
```solidity
pragma solidity ^0.8.1;
contract SimpleContract {
    
    uint public myValue = 50;
    string public myString = "Hello World!";
    
    function setValue(uint _myValue) public {
        myValue = _myValue;
    }
    
    function setString(string memory _myString) public {
        myString = _myString;
    }    
    
}
```
В примере выше смарт-контракт `SimpleContract` содержит 2 функции. Это функции "сеттеры", они изменяют состояние контракта. Состояние контракта состоит из 2-ух переменных `myValue(Int)` и `myString (String)`.

Пример достаточно примитивный, но поможет понять, что из себя представляет Solidity. В "рельных смарт-контрактах" в функциях будут операции перевода денежных средств (токенов блокчейна). Чтобы выполнить функции потребуется кошелек пользователя и его приватный ключ. Чаще всего, в роли кошелька выступают расширения для браузера. Например, для блокчейна Ethereum - [Metamask](https://metamask.io/), а для блокчейна Tron - [TronLink](https://www.tronlink.org/). Зарегистрировать свой кошелек может абсолютно любой пользователь, без паспортных данных и прочего. После регистрации пользователю присваивается адрес - идентификатор в блокчейне.
#### Как смарт-контракт попадает в сеть?
Смарт-контракт как и любое веб-приложение разрабатывается в специально запущенной среде, развернутой локально. В процессе разработки смарт-контракта также происходит тестирование и дебагинг, пишутся автотесты. С тестированием в разработке смарт-контрактов все строго, покрываемость должна быть 100% - это связано с тем, что смарт-контракт взаимодействует с денежными средствами пользователей.

После того, как разработка смарт-контракта завершена, его деплоят чаще всего в тестовую сеть. В большинстве блокчейнов также есть тестовые сети (по аналогии с продакшн и дев серверами), чтобы разработчики изучили работу смарт-контракта в блокчейне, выявили проблемные места.

Основное отличие главной сети от тестовой - в тестовой сети можно беспрепятственно получить токенов с помощью специальных инструментов. В главной сети такой возможности конечно же нет. Поэтому при интеграции со смарт-контрактами разрабатываемые приложения (backend/frontend) взаимодействуют с контрактами из тестовой сети и только после этого смарт-контракты деплоятся в главную сеть ровно как и приложения на продакшн сервер.

Процесс деплоя смарт-контрактов происходит также через специальные инструменты. Подробнее про деплой смарт-контрактов можно почитать вот [здесь](https://abhibvp003.medium.com/smart-contracts-on-the-blockchain-a-deep-dive-in-to-smart-contracts-9616ad26428c)

**ВАЖНО**

В смарт-контракте нельзя пофиксить баг или "сделать хот-фикс в продакшн". Если в смарт-контракте обнаружена уязвимость, то необходимо деплоить заново. Это означает, что адрес его поменяется, т.е. это будет совершенно другой смарт-контракт в блокчейне, никак не связанный с предыдущим (разве, что кодом). Собственно, еще одна причина требования 100% покрываемости тестов.

#### Что такое ABI контракта?

ABI смарт-контракта - это файл в формате JSON, содержаший все методы и функции этого смарт-контракта. ABI в большинстве случаев необходим для взаимодействия со смарт-контрактом. Если говорить про Ethereum, то ABI смарт-контракта можно получить, обратившись к сайту Etherscan по его адресу. Например, возьмем адрес абстрактного контракта `Governance` и найдем его в [Etherscan](https://rinkeby.etherscan.io/address/0xc9fd380b79fe4e8663fd4e6eba488b66504f9257#code).

На странице будет исходный код смарт-контракта, список транзакций по нему, его ABI и многое другое. В блокчейне все открыто, поэтому любой пользователь может посмотреть "кто когда сколько перевел денег и кому".

#### События контракта

Рассмотрим на примере контракта `Governance`. Основная задача данного смарт-контракта проводить голосование за какое-либо предложение (в детали смарт-контракта погружаться не обязательно).

```
В блокчейн-сети Ethereum находится контракт Governance. В UI необходимо вывести информацию о каждом голосовании.
- Адрес пользователя, который проголосовал;
- Значение голоса - за/против;
```

Чтобы реализовать данный функционал, нам потребуется хранить историю всех голосований. Чтобы хранить историю, нам соответственно необходим бекенд и база данных. Но, как узнать когда кто-то проголосовал? Делать rest-api? Нет, для этого в блокчейне есть события.

События можно инициализировать внутри какой-либо функции. Например, когда пользователь голосует "ЗА" - функция `voteFor`.

```solidity
contract Governance is Governable, IRewardDistributionRecipient, LPTokenWrapper, Initializable {
    event ProposalFinished(uint256 indexed _id, uint256 _for, uint256 _against, bool _quorumReached);
    event NewProposal(uint256 _id, address _creator, uint256 _start, uint256 _duration, address _executor);
    event Vote(uint256 indexed _id, address indexed _voter, bool _vote);
    ....


    /// @notice Allow registered voter to vote 'for' proposal
    /// @param _id Proposal id
    function voteFor(uint256 _id) public {
        require(proposals[_id].start < block.number, "<start");
        require(proposals[_id].end > block.number, ">end");

        uint256 _against = proposals[_id].againstVotes[_msgSender()];
        if (_against > 0) {
            proposals[_id].totalAgainstVotes = proposals[_id].totalAgainstVotes.sub(_against);
            proposals[_id].againstVotes[_msgSender()] = 0;
        }
        ...
        ...

        emit Vote(_id, _msgSender(), true);
    }
}
```

Вот как выглядит инициализация события в Solidity:

```solidity
    emit Vote(_id, _msgSender(), true);
``` 

В событие можно передать параметры, в примере выше параметры представляют из себя:

1. id голосования;
2. Адрес пользователя;
3. Результат голосования, т.к. пользователь проголосвал "За" - передается true;

Таким образом, прослушивая события в backend-приложении можно собирать статистическую инфорацию, делать эндпоинты для получения информации. Поняв, какие события предоставляет смарт-контракт и как обрабатывать эти события, можно реализовать поставленную задачу (ну эндпоинт конечно же еще закинуть).

#### Как обратиться к контракту с помощью web3? 

Для взаимодействия со смарт-контрактами есть библиотека web.js. Пример получения инстанса смарт-контракта:

```javascript
import web3 from 'web3';

const JSON_ABI = 'abi_of_smartcontract';
const address = 'address_of_smartcontract';

const contract = new web3.eth.Contract(JSON_ABI, address);
```

Теперь можно пользоваться методами смарт-контракта.

Подробнее в разделах 
 - [Примеры Typescript](../web3-examples/typescript/README.md)

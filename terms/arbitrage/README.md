### Содержание
- [Что такое арбитраж](#арбитраж)
- [Бизнес логика арбитража](#бизнес-логика-арбитража)
- [Подводные камни](#подводные-камни)

### Арбитраж
**Арбитраж** - в случае блокчейна означает покупку дешевле чего-либо на одной бирже и немедленную продажу дороже этого на другой бирже, с целью получения прибыли.

В Ethereum есть много способов для арбитража, но на примере **Uniswap** и **Sushiswap** легко объяснить, потому что **Sushiswap** - это форк **Uniswap**, что означает что их API одинаковы.

### Бизнес логика арбитража
1. Следить за последними ценами на **Uniswap** и **Sushiswap**
2. Решать, торговать или нет
3. Совершение сделки


Выглядит просто, на самом деле нет, есть свои подводные камни.

### Подводные камни
1. Комиссия за обмен **Uniswap** и **Sushiswap** (по 0.3% за каждую сделку)
2. Комиссия за транзакцию **Ethereum** (нужно смотреть на момент сделки, 5.11.2020 была примерно 4$, а в мае 2021 уже примерно 60$)
3. Проскальзывание на рынке **Uniswap** и проскальзывание на рынке **Sushiswap**

Первое и самое важное, посчитать разницу в цене после комиссии **Uniswap** и **Sushiswap**,
пример на **JavaScript** (псевдокод):

```javascript
const UNISWAP_FEE = uniswapPrice / 100 * 0.3;

const estimateProfitAfterTradingFees = (uniswapPrice, sushiswapPrice) => {
  const diff = Math.abs(sushiswapPrice - uniswapPrice);
  const diffRatio = diff / Math.max(sushiswapPrice, uniswapPrice);

  // умножаем на 2 потому что 2 сделки
  // Uniswap и SushiSwap
  const fees = UNISWAP_FEE * 2;

  return diffRatio - fees;
}
```

Если прибыль после комиссий превышает 0.01, не следует совершать сделку, потому что комиссия за транзакцию **Ethereum** (газ), скорее всего будет стоить больше.
Если прибыль после комиссии превышает стоимость комиссии **Ethereum**, то сделку совершить стоит, если сумма, которая покупается, не влияет на цену (проскальзывание).

#### Узнаем, повлияет ли сделка на цену.

**Uniswap** и **SushiSwap** - это **[AMM](../#%D0%BF%D1%83%D0%BB%D1%8B-%D0%BB%D0%B8%D0%BA%D0%B2%D0%B8%D0%B4%D0%BD%D0%BE%D1%81%D1%82%D0%B8)** - причудливый термин для объекта, который выглядит так:

*{ token0Reservations: 400, token1Reservations: 1 }*

Обратите внимание на данные в объекте: 2 числа, по 1 на каждый токен (400 и 1). Эти числа представляют количество токенов в этом смарт-контракте, ликвидность.
Так же если умножить эти резервные числа, результатом будет всегда 400. Это называется **Продуктом**(математическим продуктом) и определяется первоначальным вкладчиком в смарт контракт, это произвольное число, но оно никогда не меняется после создания.

Чтобы получить цену token0, нужно найти соотношение: **1 / 400 = 0.0025**.
Чтобы получить цену token1, нужно найти соотношение: **400 / 1 = 400**.

Эти **AMM** двусторонние: чтобы купить token0, нужно продать token1 и наоборот, чтобы купить token1, нужно продать token0.

Вернемся к расчету проскальзывания. Мы будем использовать взаимосвязь между постоянным произведением 400 и размерами резервов, чтобы увидеть цены в различных процентах от предложения резервов token1.

Например, чтобы рассчитать центу token **после** покупки 50% предложения token1, мы решим, сколько единиц token0 должно существовать, чтобы поддерживать постоянный продукт в 400, если только 0,5 единицы (50% от первоначального количества 1) token1 существует.

```
Вспоминайте школьную программу по переносу значений по другую сторону равенства )

// 1 - token1Reservers
// 0.5 - units
token0Reservers * (1 * 0.5) = 400
token0Reservers * 0.5 = 400
token0Reservers = 400 / 0.5
token0Reservers = 800
```

Это означает, что после покупки 50% token1, в резервах будет 800 единиц token0 и 0.5 единиц token1. Таким образом, новая цена (соотношение) будет 800 / 0,5 = 1600 долларов. Означает ли это, что покупка 50% предложения здесь стоит 1600 долларов? Нет, фактическая уплаченная стоимость находится где-то между первоначальной ценой в 400 долларов и окончательной ценой в 1600 долларов. В этом случае мы получили 0,5 единицы за увеличение резервов token0 на 400 единиц (800-400) / 0,5 = 800. Это средняя цена 800 token0 за 1 единицу token1. (рост цены 100%). Не дайте себя обмануть, это не линейная зависимость, покупка 80% предложения будет стоить в среднем 1333 единиц token0 за 1 единицу token1 (увеличение цены на 233%). Обратите внимание на эту экспоненциальную зависимость, потому что вы часто будете видеть ее в пулах ликвидности, где небольшие заказы могут значительно изменить цену.

Используя проскальзывание, мы можем дополнить нашу функцию **estimationProfitAfterTradingFees** другой функцией, **findMaxBet**, чтобы решить, сколько единиц token0 мы можем купить до того, как цена выйдет за пределы нашей точки безубыточности:

```javascript
const profitRate = EstimationProfitAfterTradingFees (uniPrice, sushiPrice);
const maxBet = findMaxBet (profitRate, uniReservations, sushiReservations);
const expectedProfit = maxBet * profitRate;

if (expectedProfit> 0) {
  executeTrade (maxBet);
}
```

Но эта сделка не будет завершена в 100% случаев. Почему? Потому что, либо конкурирующий arb-бот будет совершать сделку с меньшей прибылью, либо обычный передний бот клонирует вашу транзакцию с более высокой ценой на газ.